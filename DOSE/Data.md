## 1.02. Data Flow in the DOSE Framework

This page explains how data moves through the **DOSE** Apple Watch app — from real-time surveys and sensor readings to final storage in Firebase Realtime Database.

**Key Components**
* **Apple Watch (DOSE app)**: Runs the ESM/EMA surveys and collects sensor data.
* **HealthKit**: Stores passive sensor data such as heart rate and step counts, which the app queries.
* **Firebase Realtime Database**: Cloud-based storage for survey responses, sensor logs, and system events.
* **Local Storage**: Temporary on-device storage for offline robustness.

---

### 1.02.1. Data Flow Overview

a. **Prompt Scheduling & Triggering**

* The DOSE app schedules notification prompts using a custom algorithm (to work around watchOS’s 64-notification limit and to support randomized timing).
* Prompts are delivered at random or fixed intervals, depending on study settings configured in the code.

b. **User Response (Active Data)**

* When a user receives a prompt and completes a survey on the watch:
     * Their response (timestamp, survey identifier, and answer) is **stored locally**.
     * When the device is online, this response is **automatically sent to Firebase** via a direct REST API call.

c. **Sensor Data Collection (Passive Data)**

* HealthKit continuously collects physiological and activity data (e.g., heart rate, step count, sleep) as part of the Apple Watch’s native functionality — independent of the DOSE app.
* The DOSE app does not collect or store this data on its own in the background.
* The DOSE app includes an **Upload** button on its interface. When tapped:
     * The app **queries HealthKit** for all relevant data collected **since the app was installed (or last uploaded)**.
     * This data is then **batched and uploaded** to Firebase Realtime Database using direct REST API calls.
* This approach ensures efficient and **user-controlled** syncing of passive sensor data, without background tasks or constant querying.

---

### 1.02.2. What is Firebase Realtime Database?

**Firebase Realtime Database** is a cloud-based data storage service provided by Google. It allows apps to store and sync data in **real time** across devices using simple *JSON-based* data structures.

For the DOSE framework, this means:
* You don’t need to build or maintain your own server.
* Data collected on the Apple Watch (like survey responses or sensor readings) is sent directly to your Firebase database.
* You can _view, download, or analyze_ your data through the Firebase Console or access it programmatically.

Firebase Realtime Database acts as the **central hub** where all data from the DOSE app is securely stored and can be accessed for research purposes. It’s fast, reliable, and scalable—making it a good fit for lightweight wearable data collection tools.

---

### 1.02.3. Database Structure

Once the DOSE app is configured and running, all collected data is sent to your Firebase Realtime Database. The structure is organized hierarchically to separate and track data by participant and data type.

Here’s what the structure looks like:
```
devices
     - UserID
          - healthkitdata
               - [Lm2Df8Gx3Jk9VHZwX2]
                    - startDate: "2025-07-21 11:52:55AM"
                    - endDate: "2025-07-21 12:02:54PM"
                    - quantity: "668 count"
                    - type: "Steps"
               - [N7z6TgHqNfu3LmEcW4a]
                    - startDate: "2025-07-21 11:11:12AM"
                    - endDate: "2025-07-21 11:11:12AM"
                    - quantity: "1.23 count/s"
                    - type: "HeartRate"
               - [...]
          - notifications
               - [McX78bnFa7LsKyq14Pq]
                    - delivered: "2025-07-23 08:05:00AM"
                    - opened: "2025-07-23 08:05:03AM"
               - [...]
          - responses
               - [Oe9HtMn3XdQJpV5Yu1r]
                    - delivered: "2025-07-23 08:05:00AM"
                    - opened: "2025-07-23 08:05:02AM"
                    - submitted: "2025-07-23 08:05:05AM"
                    - surveyNo: "Q3. Step Slider"
                    - response: "30.0"
               - [Ph4Rsz90LxWqBn4Y8Tg]
                    - delivered: "2025-07-23 10:30:00AM"
                    - opened: "2025-07-23 11:30:35AM"
                    - submitted: "2025-07-23 11:30:36AM"
                    - surveyNo: "N/A"
                    - response: "Expired"
               - [...]
```
When viewing your Firebase Realtime Database, you’ll notice that each event (such as a survey response or sensor upload) is stored under a long alphanumeric key (e.g., `"Lm2Df8Gx3Jk9VHZwX2"`, `"N7z6TgHqNfu3LmEcW4a"`). These keys are automatically generated by Firebase to uniquely identify each entry and ensure that events can be safely stored and retrieved without conflict.

* `devices`: This is the top-level node where all data is stored. Under this, each participant is represented by a unique UserID — usually their Firebase Authentication ID or custom identifier.
* `healthkitdata`: Stores passive sensor data pulled from HealthKit, such as heart rate and step counts.
    * Each entry has an auto-generated key (like `-Lm2Df8Gx3Jk9VHZwX2`) and includes:
        * `startDate` and `endDate`: Time range of the measurement.
        * `quantity`: The measured value, e.g., "668 count" for steps.
        * `type`: The kind of data, e.g., `"Steps"` or `"HeartRate"`.
* `notifications`: Tracks when survey prompts were delivered and the participant opened them (regardless of response submission status).
    * Each entry records:
        * `delivered`: When the notification appeared.
        * `opened`: When the user tapped the notification (if they did).
* `responses`: Stores the user’s responses to ESM/EMA surveys.
    * Each entry includes:
        * `delivered`: When the survey prompt was sent.
        * `opened`: When the user opened the survey.
        * `submitted`: When the survey was completed.
        * `surveyNo`: Identifier for the specific question or screen.
        * `response`: The user’s answer (or "Expired" if they missed it).

---

### 1.02.4. **Why Are Notifications and Responses Logged Separately?**

By storing notifications and responses in separate logs, DOSE allows you to detect partial interactions. For example, if a notification was opened but no corresponding response was submitted, it may suggest:
* The participant got distracted and never completed the survey.
* The app was closed or crashed before submission.
* The user opened it by mistake and ignored it.
* The time window for submission expired after opening.
This separation gives researchers greater transparency into compliance and app engagement patterns.

**NOTE**: watchOS does not provide a method to detect notifications that were *delivered but never opened*, so if a user ignores or misses a prompt entirely, it will not appear in the logs—only opened or interacted-with notifications are recorded. The DOSE framework uses the `UNUserNotificationCenter` API to locally schedule notifications, which means they are stored directly on the watch and do not rely on network connectivity at the time of delivery. This approach ensures near-100% reliability under normal conditions. The only known reasons a notification might not appear are if the user has disabled notifications for the app or if the watch is in a Focus mode (such as Do Not Disturb, Sleep, or Work).


[Back to Top](#top)






